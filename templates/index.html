<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Audio Classifier with Upload & Mic Record</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Bootstrap 5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    background-color: #f8f9fa;
  }
  #image-container {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }
  #image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    cursor: pointer;
  }
  #result {
    margin-top: 20px;
  }
  button {
    margin-bottom: 10px;
  }
</style>
</head>

<body>
<div class="container py-5">
  <h2 class="mb-4 text-center">Upload or Record Audio to Classify</h2>

  <div class="row">
    <div class="col-lg-6">

      <!-- Upload Form -->
      <form id="uploadForm" class="mb-4" enctype="multipart/form-data">
        <div class="mb-3">
          <input type="file" class="form-control" name="file" id="fileInput" accept=".wav,.mp3,.wmv" />
        </div>
        <button type="submit" class="btn btn-primary w-100">Classify Upload</button>
      </form>

      <hr />

      <!-- Mic Recording -->
      <div class="mb-3 text-center">
        <button id="startBtn" class="btn btn-success">Start Recording</button>
        <button id="stopBtn" class="btn btn-danger" disabled>Stop Recording</button>
      </div>
      <audio id="audioPlayback" controls style="width: 100%; margin-bottom: 15px;"></audio>

      <div id="result" class="alert alert-info d-none text-center"></div>

      <!-- Controls for images and audio -->
      <div id="controls" class="text-center row">
        <div class="col">
          <button class="btn btn-transparent p-0" id="btnCar">
            <img class="icon img-fluid" src="{{ url_for('static', filename='img/car.png') }}" alt="Normal Light" />
          </button>
          <audio id="car" src="{{ url_for('static', filename='music/car.wav') }}"></audio>
        </div>
        <div class="col">
          <button class="btn btn-transparent p-0" id="btnRain">
            <img class="icon img-fluid" src="{{ url_for('static', filename='img/rain.png') }}" alt="Rain and Thunder" />
          </button>
          <audio id="rain" src="{{ url_for('static', filename='music/rain.mp3') }}"></audio>
        </div>
        <div class="col">
          <button class="btn btn-transparent p-0" id="btnNoise">
            <img class="icon img-fluid" src="{{ url_for('static', filename='img/noise.png') }}" alt="Dim" />
          </button>
          <audio id="noise" src="{{ url_for('static', filename='music/noise.mp3') }}"></audio>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div id="image-container">
        <img id="status-image" src="{{ url_for('static', filename='img/SC-Street-Simulator0001.webp') }}" alt="Preview" />
      </div>
    </div>
  </div>
</div>

<script>
  // ==== Upload audio file handling ====
  document.getElementById("uploadForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) return alert("Please select a file first");

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    const resultDiv = document.getElementById("result");
    const statusImage = document.getElementById("status-image");

    try {
      const response = await fetch("https://salma-production.up.railway.app/predict", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();

      console.log(data);

      if (response.ok && data.result) {
        handlePredictionResult(data.result);
      } else {
        showError(data.error || "Server error");
      }
    } catch (err) {
      showError("Network error: " + err.message);
    }
  });

  // ==== Mic recording + downsampling + sending ====

  let audioContext, mediaStream, sourceNode, processorNode;
  let audioData = [];
  const SAMPLE_RATE = 16000;

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const audioPlayback = document.getElementById("audioPlayback");
  const resultDiv = document.getElementById("result");
  const statusImage = document.getElementById("status-image");

  startBtn.onclick = async () => {
    audioData = [];
    clearResult();

    startBtn.disabled = true;
    stopBtn.disabled = false;

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    sourceNode = audioContext.createMediaStreamSource(mediaStream);

    const bufferSize = 4096;
    processorNode = audioContext.createScriptProcessor(bufferSize, 1, 1);

    sourceNode.connect(processorNode);
    processorNode.connect(audioContext.destination);

    processorNode.onaudioprocess = (e) => {
      const inputBuffer = e.inputBuffer.getChannelData(0);
      audioData.push(new Float32Array(inputBuffer));
    };
  };

  stopBtn.onclick = async () => {
    stopBtn.disabled = true;
    startBtn.disabled = false;

    processorNode.disconnect();
    sourceNode.disconnect();
    mediaStream.getTracks().forEach((t) => t.stop());
    await audioContext.close();

    const rawBuffer = flattenArray(audioData);

    // Downsample
    const inputSampleRate = audioContext.sampleRate;
    const downsampledBuffer = downsampleBuffer(rawBuffer, inputSampleRate, SAMPLE_RATE);

    // Encode WAV
    const wavBlob = encodeWAV(downsampledBuffer, SAMPLE_RATE);

    // Show playback
    const audioUrl = URL.createObjectURL(wavBlob);
    audioPlayback.src = audioUrl;

    // Send to server
    const formData = new FormData();
    formData.append("file", wavBlob, "recording.wav");

    try {
      const res = await fetch("https://salma-production.up.railway.app/predict", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();

      if (res.ok && data.result) {
        handlePredictionResult(data.result);
      } else {
        showError(data.error || "Server error");
      }
    } catch (err) {
      showError("Fetch error: " + err.message);
    }
  };

  // ==== Helper functions ====

  function flattenArray(channelBuffers) {
    let length = 0;
    channelBuffers.forEach((buf) => (length += buf.length));
    let result = new Float32Array(length);
    let offset = 0;
    channelBuffers.forEach((buf) => {
      result.set(buf, offset);
      offset += buf.length;
    });
    return result;
  }

  function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
    if (outputSampleRate === inputSampleRate) {
      return buffer;
    }
    if (outputSampleRate > inputSampleRate) {
      throw new Error("Output sample rate should be less than input sample rate");
    }
    const sampleRateRatio = inputSampleRate / outputSampleRate;
    const newLength = Math.round(buffer.length / sampleRateRatio);
    const result = new Float32Array(newLength);
    let offsetResult = 0,
      offsetBuffer = 0;
    while (offsetResult < newLength) {
      const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
      let accum = 0,
        count = 0;
      for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
        accum += buffer[i];
        count++;
      }
      result[offsetResult] = accum / count;
      offsetResult++;
      offsetBuffer = nextOffsetBuffer;
    }
    return result;
  }

  function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);

    writeString(view, 0, "RIFF");
    view.setUint32(4, 36 + samples.length * 2, true);
    writeString(view, 8, "WAVE");
    writeString(view, 12, "fmt ");
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true); // mono
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, "data");
    view.setUint32(40, samples.length * 2, true);

    floatTo16BitPCM(view, 44, samples);

    return new Blob([view], { type: "audio/wav" });
  }

  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  }

  function floatTo16BitPCM(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, input[i]));
      s = s < 0 ? s * 0x8000 : s * 0x7fff;
      output.setInt16(offset, s, true);
    }
  }

  // ==== UI & audio control functions ====

  const carAudio = document.getElementById("car");
  const rainAudio = document.getElementById("rain");
  const noiseAudio = document.getElementById("noise");

  document.getElementById("btnCar").onclick = () => {
    playAudio("car", "normal");
  };
  document.getElementById("btnRain").onclick = () => {
    playAudio("rain", "rain");
  };
  document.getElementById("btnNoise").onclick = () => {
    playAudio("noise", "dim");
  };

  function playAudio(name, label) {
    stopAllAudio();
    if (name === "car") carAudio.play();
    else if (name === "rain") rainAudio.play();
    else if (name === "noise") noiseAudio.play();

    updateUIByLabel(label);
  }

  function stopAllAudio() {
    [carAudio, rainAudio, noiseAudio].forEach((audio) => {
      audio.pause();
      audio.currentTime = 0;
    });
  }

  function updateUIByLabel(label) {
    switch (label) {
      case "rain":
      case "Rain and thunder":
      case "Rain and Thunder":
        statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0003.webp') }}";
        break;
      case "dim":
      case "Noise":
      case "noise":
        statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0001.webp') }}";
        break;
      case "normal":
      case "Car":
      case "car":
        statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0002.webp') }}";
        break;
      default:
        statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0001.webp') }}";
        break;
    }
  }

  // ==== Handle prediction result ====

  function handlePredictionResult(result) {
    const { label, confidence } = result;
    resultDiv.classList.remove("d-none", "alert-danger");
    resultDiv.classList.add("alert-info");
    resultDiv.innerText = `Prediction: ${label}, with confidence ${(confidence * 100).toFixed(2)}%`;

    // تشغيل الصوت وتغيير الصورة حسب التسمية
    let labelKey = label.toLowerCase();
    if (labelKey.includes("rain")) {
      playAudio("rain", "rain");
    } else if (labelKey.includes("noise")) {
      playAudio("noise", "dim");
    } else if (labelKey.includes("car")) {
      playAudio("car", "normal");
    } else {
      stopAllAudio();
      updateUIByLabel("unknown");
    }
  }

  function showError(msg) {
    resultDiv.classList.remove("d-none", "alert-info");
    resultDiv.classList.add("alert-danger");
    resultDiv.innerText = msg;
    stopAllAudio();
    updateUIByLabel("unknown");
  }

  function clearResult() {
    resultDiv.classList.add("d-none");
    resultDiv.innerText = "";
    stopAllAudio();
    updateUIByLabel("unknown");
  }
</script>
</body>
</html>
