<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Classifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    #image-container img {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4 text-center">Record Audio & Classify</h2>

    <div class="row">
      <!-- Controls & Result -->
      <div class="col-6 text-center">
        <button id="startBtn" class="btn btn-success me-2">üéô Start Recording</button>
        <button id="stopBtn" class="btn btn-danger" disabled>‚èπ Stop & Classify</button>
        <div id="result" class="alert d-none mt-4"></div>
      </div>

      <!-- Image -->
      <div class="col-6">
        <div id="image-container" class="text-center">
          <img id="status-image" 
               src="{{ url_for('static', filename='img/SC-Street-Simulator0001.webp') }}" 
               alt="Preview">
        </div>
      </div>
    </div>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resultDiv = document.getElementById("result");
    const statusImage = document.getElementById("status-image");

    function showMessage(message, type) {
      resultDiv.className = "alert mt-4";
      resultDiv.classList.add(`alert-${type}`);
      resultDiv.textContent = message;
      resultDiv.classList.remove("d-none");
    }

    // Start recording
    startBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.start();

        startBtn.disabled = true;
        stopBtn.disabled = false;
        resultDiv.classList.add("d-none");
      } catch (err) {
        showMessage("Microphone access denied or unavailable.", "danger");
      }
    });

    // Stop and classify
    stopBtn.addEventListener("click", () => {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.wav");

        try {
          const response = await fetch("http://127.0.0.1:5000/predict", {
            method: "POST",
            body: formData
          });

          console.log(audioBlob);
          console.log(formData);
          
          const data = await response.json();

          console.log(data);

          if (response.ok && data.result) {
            const label = data.result.label || "Unknown";
            const confidence = 
              typeof data.result.confidence === "number" 
              ? data.result.confidence.toFixed(2) 
              : "N/A";

            showMessage(`Prediction: ${label}, Confidence: ${confidence}`, "info");

            // Change image depending on label
            if (label === "Rain and thunder") {
              statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0003.webp') }}";
            } else {
              statusImage.src = "{{ url_for('static', filename='img/SC-Street-Simulator0002.webp') }}";
            }
          } else {
            showMessage(`Invalid API response: ${JSON.stringify(data)}`, "danger");
          }
        } catch (err) {
          showMessage(`Network error: ${err}`, "danger");
        }
      };
    });
      
     function displayPrediction(prediction, confidence) {
    console.log("üîç Debug: Raw prediction =", prediction);
    console.log("üîç Debug: Raw confidence =", confidence);

    let predText;
    let confText;

    if (prediction && typeof prediction === "string" && prediction.trim() !== "") {
        predText = prediction;
    } else {
        console.warn("‚ö† No valid prediction, using 'Unknown'");
        predText = "Unknown";
    }

    if (typeof confidence === "number" && !isNaN(confidence)) {
        confText = confidence.toFixed(2) + "%";
    } else {
        console.warn("‚ö† No valid confidence, using 'N/A'");
        confText = "N/A";
    }

    document.getElementById("prediction").textContent =
        `Prediction: ${predText}, Confidence: ${confText}`;
}


  </script>
</body>
</html>
